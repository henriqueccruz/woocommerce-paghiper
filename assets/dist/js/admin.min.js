(function(){var N=Object.defineProperty;var j=(e,c,u)=>c in e?N(e,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):e[c]=u;var P=(e,c,u)=>j(e,typeof c!="symbol"?c+"":c,u);jQuery(function(e){function c(o){const{message:i,type:t="info",duration:s=3e3}=o;e("#ph-reusable-notifications").length||e("body").append('<div id="ph-reusable-notifications"></div>');const d=e("<div></div>").addClass(`ph-notification ${t}`).html(i);return e("#ph-reusable-notifications").append(d),s>0&&setTimeout(()=>{d.addClass("fade-out"),d.on("animationend",()=>{d.remove()})},s),d}if(typeof paghiper_settings>"u"||!e("#paghiper-due-date-container").length)return;const b=e("#woocommerce_paghiper_pix_due_date_mode, #woocommerce_paghiper_billet_due_date_mode"),g=e("#woocommerce_paghiper_pix_due_date_value, #woocommerce_paghiper_billet_due_date_value"),M=e("#woocommerce_paghiper_pix_api_key, #woocommerce_paghiper_billet_api_key"),S=e("#copy-credentials, #test-credentials");M.length&&S.length&&S.insertAfter(M);const x=e("#due-date-mode-toggle"),_=e("#days-mode-section"),I=e("#minutes-mode-section");e(".mode-switcher.disabled").on("click",function(o){o.preventDefault(),c({message:"Essa opção está disponível apenas para o PIX PagHiper.",type:"info"})}),paghiper_settings.is_pix?x.on("change",function(){const o=e(this).is(":checked");_.toggleClass("active",!o),I.toggleClass("active",o),b.val(o?"minutes":"days").trigger("change"),m()}):(_.addClass("active"),I.removeClass("active"),b.val("days")),e("#mainform").on("submit",function(o){if(paghiper_settings.is_pix&&b.val()==="minutes"){const i=g.val();i<5&&(confirm(`A(s) transação(ões) gerada(s) vai(vão) expirar em apenas ${i} minutos. Continuar?`)||o.preventDefault())}});let l={},w;function m(){if(paghiper_settings.is_pix&&x.is(":checked")){const o=l.days.value,i=l.hours.value,t=l.minutes.value,s=o*24*60+i*60+t;g.val(s).trigger("change")}else g.val(w.value).trigger("change")}class D{constructor(i){this.element=e('<div class="odometer-digit"></div>'),this.currentValue=parseInt(i,10),this.rotor=e('<div class="odometer-rotor"></div>');for(let t=0;t<10;t++)this.rotor.append(e('<div class="odometer-digit-value"></div>').text(t));this.rotor.append(e('<div class="odometer-digit-value"></div>').text(0)),this.element.append(this.rotor)}initializePosition(){const i=this.element.height();i!==0&&this.rotor.css({transition:"none",transform:`translateY(-${this.currentValue*i}px)`})}setValue(i,t){if(i===this.currentValue)return;const s=this.element.height();if(s===0)return;const a=this.rotor,d=this.currentValue===9&&i===0&&t>0,n=this.currentValue===0&&i===9&&t<0;d?(a.css({transition:"transform 0.4s ease-in-out",transform:`translateY(-${10*s}px)`}),setTimeout(()=>{a.css({transition:"none",transform:"translateY(0px)"})},400)):n?(a.css({transition:"none",transform:`translateY(-${10*s}px)`}),setTimeout(()=>{a.css({transition:"transform 0.4s ease-in-out",transform:`translateY(-${9*s}px)`})},20)):a.css({transition:"transform 0.4s ease-in-out",transform:`translateY(-${i*s}px)`}),this.currentValue=i}}const v=class v{constructor(i,t,s){this.container=e(i),this.config=v.LIMITS[s],this.value=Math.max(this.config.min,Math.min(t,this.config.max)),this.digits=[],this.isEditing=!1,this.wrapper=e('<div class="odometer-display"></div>'),this.container.html(this.wrapper);const a=this.value>=100?3:2,d=this.value.toString().padStart(a,"0");for(let n=0;n<d.length;n++){const r=new D(d[n]);this.digits.push(r),this.wrapper.append(r.element),r.initializePosition()}this.digits.length===3?this.wrapper.addClass("has-three-digits"):this.wrapper.removeClass("has-three-digits"),this.wrapper.on("click",()=>{this.isEditing||this.showInput()})}showInput(){let i=this.wrapper.outerWidth(),t=this.wrapper.outerHeight();console.log(i,t),this.isEditing=!0,this.wrapper.hide();const s=e('<input type="number" class="odometer-input" />');s.css({"min-width":i+"px",width:i+"px",height:t+"px","font-size":"1.8em","text-align":"center",border:"1px solid #999","background-color":"#fff","box-sizing":"border-box",margin:0,padding:0}),s.val(this.value),this.container.append(s),s.focus().select();const a=e('<span style="display:none"></span>');a.css({"font-size":s.css("font-size"),"font-family":s.css("font-family")}),e("body").append(a),s.on("input",function(){a.text(e(this).val()),e(this).css("width",a.width()+10+"px")}).trigger("input");const d=()=>{let n=parseInt(s.val(),10);if(isNaN(n)?n=this.value:n=Math.max(this.config.min,Math.min(n,this.config.max)),s.remove(),this.wrapper.show(),this.isEditing=!1,n!==this.value){const r=n>this.value?1:-1;this.setValue(n,r),m()}};s.on("blur",d),s.on("keydown",n=>{n.key==="Enter"?d():n.key==="Escape"&&(s.remove(),this.wrapper.show(),this.isEditing=!1)})}setValue(i,t){if(i===this.value)return;const s=i>=100?3:2,a=this.value.toString(),d=i.toString(),n=this.digits.length,r=Math.max(s,d.length);if(r>n)for(let p=n;p<r;p++){const f=new D("0");this.digits.unshift(f),this.wrapper.prepend(f.element),f.initializePosition()}else if(r<n)for(let p=r;p<n;p++)this.digits[0].element.remove(),this.digits.shift();r===3?this.wrapper.addClass("has-three-digits"):this.wrapper.removeClass("has-three-digits");const y=a.padStart(this.digits.length,"0"),V=d.padStart(this.digits.length,"0");for(let p=0;p<this.digits.length;p++){const f=parseInt(y[p],10),E=parseInt(V[p],10);f!==E&&this.digits[p].setValue(E,t)}this.value=i}increment(){let i=!1,t=this.value+1;return t>this.config.max&&(t=this.config.wrap?this.config.min:this.config.max,i=!0),this.setValue(t,1),i}decrement(){let i=!1,t=this.value-1;return t<this.config.min&&(t=this.config.max,i=!0),this.setValue(t,-1),i}};P(v,"LIMITS",{"boleto-days":{min:1,max:400,wrap:!0},"pix-days":{min:0,max:400,wrap:!0},hours:{min:0,max:23,wrap:!0},minutes:{min:0,max:59,wrap:!0}});let h=v;const C=paghiper_settings.due_date_mode==="days"?parseInt(paghiper_settings.due_date_value,10):1,T=paghiper_settings.is_pix?"pix-days":"boleto-days";if(w=new h(_.find(".days-display"),C,T),_.find(".chevron-control").on("click",function(){if(e(".odometer-input").length){e(".odometer-input").trigger("blur");return}e(this).data("action")==="increment"?w.increment():w.decrement(),m()}),paghiper_settings.is_pix){let o=function(){let i={days:0,hours:0,minutes:30};if(paghiper_settings.due_date_mode==="minutes"){const t=parseInt(paghiper_settings.due_date_value,10);!isNaN(t)&&t>0&&(i={days:Math.floor(t/(24*60)),hours:Math.floor(t%(24*60)/60),minutes:t%60})}l.days=new h(e("#cron-days-pix"),i.days,"pix-days"),l.hours=new h(e("#cron-hours-pix"),i.hours,"hours"),l.minutes=new h(e("#cron-minutes-pix"),i.minutes,"minutes"),m()};var z=o;o(),e("#minutes-mode-section .chevron-control").on("click",function(){if(e(".odometer-input").length){e(".odometer-input").trigger("blur");return}const i=e(this),t=i.data("unit");i.data("action")==="increment"?l[t].increment()&&(t==="minutes"?l.hours.increment()&&l.days.increment():t==="hours"&&l.days.increment()):l[t].decrement()&&(t==="minutes"?l.hours.decrement()&&l.days.decrement():t==="hours"&&l.days.decrement()),m()}),x.trigger("change")}e("#copy-credentials").on("click",function(){let o=null;o=c({message:'<span class="ph-notification-spinner"></span> Copiando credenciais...',type:"info",duration:0}),e.post(ajaxurl,{action:"paghiper_copy_credentials",nonce:paghiper_settings.nonce,to:paghiper_settings.gateway_id},function(t){t.success?(c({message:"Credenciais configuradas com sucesso!",type:"success",duration:5e3}),setTimeout(()=>{location.reload()},1e3)):c({message:t.data.message,type:"error"}),o&&o.remove()})}),e("#test-credentials").on("click",function(){const o=e("#woocommerce_paghiper_pix_api_key, #woocommerce_paghiper_billet_api_key").val(),i=e("#woocommerce_paghiper_pix_token, #woocommerce_paghiper_billet_token").val();let t=null;t=c({message:'<span class="ph-notification-spinner"></span> Testando credenciais...',type:"info",duration:0}),e.post(ajaxurl,{action:"paghiper_test_credentials",nonce:paghiper_settings.nonce,apiKey:o,token:i},function(a){a.success?c({message:a.data.message,type:"success"}):c({message:a.data.message,type:"error"}),t&&t.remove()}).fail(function(a,d,n){a.status===500?c({message:"Servidor indisponível (erro 500)",type:"error"}):c({message:"Não foi possível checar suas credenciais agora.",type:"error"}),t&&t.remove()})});const k={form:e("form#mainform"),modal:e("#paghiper-downloader-modal"),progressBar:e("#paghiper-downloader-modal .paghiper-progress"),statusMessage:e("#paghiper-downloader-modal .paghiper-status-message"),initialMessage:e("#paghiper-downloader-modal .paghiper-modal-initial-message"),isDownloading:!1,init:function(){this.form.on("submit",this.handleSubmit.bind(this))},openModal:function(){e("body").css("overflow","hidden"),this.modal.dialog({modal:!0,width:500,closeOnEscape:!1,draggable:!1,resizable:!1,open:function(o,i){let t=e(this).parent().find(".ui-dialog-titlebar"),s=e(this).parent().find(".paghiper-modal-content");t.prependTo(s),e(this).parent().find(".ui-dialog-titlebar-close").hide()}})},closeModal:function(){e("body").css("overflow",""),this.modal.is(":ui-dialog")&&this.modal.dialog("close")},updateProgress:function(o,i){this.progressBar.css({width:o+"%",backgroundColor:"#4CAF50",color:"#fff"}).text(Math.round(o)+"%"),this.statusMessage.text(i)},showError:function(o){this.isDownloading=!1,this.updateProgress(100,"Erro."),this.progressBar.css("background-color","#dc3232"),this.statusMessage.html(o+'<br/><br/><button class="button button-primary" id="close-downloader-modal">Fechar</button>'),e("#close-downloader-modal").on("click",this.closeModal.bind(this))},downloadBundle:function(o){return e.post(ajaxurl,{action:"paghiper_download_timer_assets",nonce:paghiper_settings.nonce,bundle:o})},downloadSequentially:function(o){const i=e.Deferred(),t=o.length;let s=0;const a=()=>{if(s>=t){i.resolve();return}const d=o[s],n=(s+1)/t*100;this.updateProgress(n,`Baixando pacote ${s+1} de ${t}...`),this.downloadBundle(d).done(r=>{if(r.success)s++,a();else{const y=r.data&&r.data.message?r.data.message:"Ocorreu um erro no servidor.";this.showError(y),i.reject()}}).fail(r=>{this.showError("Falha de comunicação com o servidor. Verifique sua conexão e os logs de erro do PHP."),i.reject()})};return a(),i.promise()},handleSubmit:function(o){if(this.isDownloading){o.preventDefault();return}const i=paghiper_settings.gateway_id==="paghiper_pix",t=e("#due-date-mode-toggle").is(":checked"),s=e("#woocommerce_paghiper_pix_disable_email_gif").is(":checked");if(!i||!t||s||this.form.find("#paghiper_assets_checked").length>0)return;o.preventDefault(),this.isDownloading=!0,this.openModal(),this.progressBar.css({width:"100%",backgroundColor:"transparent",color:"#2c3338"}),this.modal.find(".paghiper-modal-initial-message").show(),this.updateProgress(0,"");const a=parseInt(g.val(),10)||0,d=Math.ceil(a/60);this.updateProgress(0,"Verificando pacotes necessários..."),e.post(ajaxurl,{action:"paghiper_get_timer_asset_status",nonce:paghiper_settings.nonce,bundles_needed:d}).done(n=>{if(!n.success){this.showError(n.data.message);return}const r=n.data.missing_bundles;if(r.length===0){this.updateProgress(100,"Recursos já estão instalados e verificados!"),setTimeout(()=>{this.isDownloading=!1,this.closeModal(),this.form.append('<input type="hidden" id="paghiper_assets_checked" name="paghiper_assets_checked" value="1">'),console.log("Submitting with due_date_value:",g.val()),this.form.find('button[name="save"]').click()},1500);return}this.downloadSequentially(r).done(()=>{this.progressBar.css("background-color","#4CAF50"),this.updateProgress(100,"Todos os pacotes foram instalados com sucesso!"),setTimeout(()=>{this.isDownloading=!1,this.closeModal(),this.form.append('<input type="hidden" id="paghiper_assets_checked" name="paghiper_assets_checked" value="1">'),this.form.find('button[name="save"]').click()},1500)}).fail(()=>{console.log("Download sequence failed and was caught.")})}).fail(n=>{const r="Falha na comunicação com o servidor ao verificar o status dos pacotes. (Status: "+n.status+" "+n.statusText+"). Verifique os logs do servidor para mais detalhes.";this.showError(r)})}};typeof paghiper_settings<"u"&&paghiper_settings.gateway_id==="paghiper_pix"&&k.init(),window.paghiperDownloader=k,{button:e("#paghiper-install-beta"),downloader:k,init:function(){this.button.length&&this.button.on("click",this.handleInstall.bind(this))},handleInstall:function(o){o.preventDefault();const i=this.button.data("version");this.downloader.isDownloading=!0,this.downloader.openModal(),this.downloader.updateProgress(0,"Iniciando instalação da versão "+i+"..."),e.post(ajaxurl,{action:"paghiper_install_beta_version",nonce:paghiper_settings.nonce,version:i}).done(t=>{t.success?(this.downloader.updateProgress(100,t.data.message),setTimeout(()=>location.reload(),2e3)):this.downloader.showError(t.data.message||"Ocorreu um erro desconhecido.")}).fail(t=>{const s=t.responseJSON&&t.responseJSON.data&&t.responseJSON.data.message?t.responseJSON.data.message:"Falha na comunicação com o servidor (Status: "+t.status+"). Verifique os logs.";this.downloader.showError(s)})}}.init()});
})();